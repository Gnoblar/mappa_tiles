<!doctype html>
<html lang="it">
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="initial-scale=1,user-scalable=no,maximum-scale=1,width=device-width">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-capable" content="yes">

    <!-- CSS -->
    <link rel="stylesheet" href="css/leaflet.css">
    <link rel="stylesheet" href="css/L.Control.Layers.Tree.css">
    <link rel="stylesheet" href="css/qgis2web.css">
    <link rel="stylesheet" href="css/fontawesome-all.min.css">
    <link rel="stylesheet" href="css/leaflet.photon.css">
    <style>
      html, body, #map { width: 100%; height: 100%; padding: 0; margin: 0; }
      .confini-label { font-weight: 600; text-shadow: 0 0 2px #fff; }
    </style>
    <title>Mappa</title>
  </head>
  <body>
    <div id="map"></div>

    <!-- JS base -->
    <script src="js/qgis2web_expressions.js"></script>
    <script src="js/leaflet.js"></script>
    <script src="js/L.Control.Layers.Tree.min.js"></script>
    <script src="js/leaflet.rotatedMarker.js"></script>
    <script src="js/leaflet.pattern.js"></script>
    <script src="js/leaflet-hash.js"></script>
    <script src="js/Autolinker.min.js"></script>
    <script src="js/rbush.min.js"></script>
    <script src="js/labelgun.min.js"></script>
    <script src="js/labels.js"></script>
    <script src="js/leaflet.photon.js"></script>

    <!-- Vettori (nuovi) -->
    <script src="data/Insediamenti_2.js?v=1"></script>
    <script src="data/Confinipolitici_1.js?v=1"></script>

    <script>
      // Evidenziazione popup
      var highlightLayer;
      function highlightFeature(e) {
        highlightLayer = e.target;
        highlightLayer.openPopup();
      }

      // Mappa base
      var map = L.map('map', { zoomControl: false, minZoom: 0, maxZoom: 17 });
      new L.Hash(map);
      map.attributionControl.setPrefix(
        '<a href="https://github.com/tomchadwin/qgis2web" target="_blank">qgis2web</a> &middot; ' +
        '<a href="https://leafletjs.com">Leaflet</a> &middot; ' +
        '<a href="https://qgis.org">QGIS</a>'
      );
      var autolinker = new Autolinker({ truncate: { length: 30, location: 'smart' } });

      // Basemap: tiles locali (XYZ)
      var basemap0 = L.tileLayer('./tiles_raster/{z}/{x}/{y}.jpg', {
        attribution: '© mappa raster',
        minZoom: 0,
        maxZoom: 17,
        maxNativeZoom: 17,
        tms: false,
        noWrap: true,
        detectRetina: false,
        keepBuffer: 4
      }).addTo(map);

      L.control.zoom({ position: 'topleft' }).addTo(map);
      var bounds_group = new L.featureGroup([]);
      function setBounds() {}

      // ---------- INSEDIAMENTI_2 (punti) ----------
      function pop_Insediamenti_2(feature, layer) {
        layer.on({
          mouseover: highlightFeature,
          mouseout: e => (typeof layer.closePopup === 'function' ? layer.closePopup() : null),
        });
        const p = feature.properties || {};
        const asText = v => (v != null ? autolinker.link(String(v)) : '');
        var popupContent =
          '<table>' +
          '<tr><th scope="row">Nome</th><td>' + asText(p.Nome) + '</td></tr>' +
          '<tr><th scope="row">Tipo</th><td>' + asText(p.Tipo) + '</td></tr>' +
          '<tr><th scope="row">Descrizione</th><td>' + asText(p.Descrizione) + '</td></tr>' +
          '<tr><th scope="row">Livello</th><td>' + asText(p.Livello) + '</td></tr>' +
          '<tr><th scope="row">Regione</th><td>' + asText(p.Regione) + '</td></tr>' +
          '</table>';
        layer.bindPopup(popupContent, { maxHeight: 400 });
      }
      function style_Insediamenti_2_0() {
        return {
          pane: 'pane_Insediamenti_2',
          radius: 4,
          color: 'rgba(35,35,35,1.0)',
          weight: 1,
          fill: true,
          fillOpacity: 1,
          fillColor: 'rgba(190,207,80,1.0)',
          interactive: true
        };
      }
      map.createPane('pane_Insediamenti_2');
      map.getPane('pane_Insediamenti_2').style.zIndex = 401;
      map.getPane('pane_Insediamenti_2').style['mix-blend-mode'] = 'normal';

      var layer_Insediamenti_2 = new L.geoJson(json_Insediamenti_2, {
        pane: 'pane_Insediamenti_2',
        onEachFeature: pop_Insediamenti_2,
        pointToLayer: (feature, latlng) => L.circleMarker(latlng, style_Insediamenti_2_0()),
        attribution: '',
        interactive: true
      });
      bounds_group.addLayer(layer_Insediamenti_2).addTo(map);

      // ---------- CONFINIPOLITICI_1 ----------
      // Dizionario Nome -> colore (tuo elenco)
      const colorByNome = {
        "Terre di Brea": "#9ce53b",
        "Terra di Nurn": "#ff3535",
        "Terra di Gorgoroth": "#ad0e0e",
        "Terra di Buck": "#c47e2e",
        "Regno di Umbar": "#eaf133",
        "Regno di Sagatavuld": "#d5d5d5",
        "Regno di Rostamush": "#ff7e21",
        "Regno di Rohan": "#27772b",
        "Regno di Pezarsan": "#e8e674",
        "Regno di Narimanush": "#bf4a16",
        "Regno di Haruzan": "#f3ff4f",
        "Regno di Gundabad": "#4a6b42",
        "Regno di Gondor": "#bcd1d7",
        "Regno di Gobel Mirlond": "#9a9d58",
        "Regno di Erebor": "#b7b7b7",
        "Regno di Dorwinion": "#e15989",
        "Regno di Dale": "#607ff3",
        "Regno di Chelkar": "#aab72f",
        "Regno di Carn Dum": "#be2964",
        "Regno di Bozorganush": "#ff9e17",
        "Regno di Ar-Adunaim": "#1b0f02",
        "Regno dei Goblin delle Montagne Nebbiose": "#9aa475",
        "Regno dei Beorniani": "#f2b4ff",
        "Regno degli Ered Luin": "#7d8b8f",
        "Reame di Lothlorien": "#33cd99",
        "Reame di Lindon": "#0a1cbe",
        "Reame dei Colli Ferrosi": "#b9b9b9",
        "Reame Boscoso": "#075a19",
        "Principato dei Pinnath Gelin": "#b37ff1",
        "Principato del Lebennin": "#b8b9bf",
        "Principato del Dol Amroth": "#96c9cf",
        "Marca dell'Ovestfalda": "#51e469",
        "Marca dell'Estfalda": "#06b005",
        "Marca dell'Estemnet": "#8fc815",
        "Khanato di Sturlurza Khand": "#936f52",
        "Khanato di Ammu Khand": "#8e5350",
        "Isengard": "#ebebeb",
        "Imladris": "#272b8f",
        "Faerdor": "#987db7",
        "Dynion Saerlann": "#cfa1ff",
        "Dominio di Dol Guldur": "#b71111",
        "Contea": "#becf50",
        "Confederazione Dunedain": "#2e73ff",
        "Confederazione dell'Anduin": "#c46b98",
        "Confederazione del Rhudaur": "#b69559",
        "Confederazione del Dunland": "#c3d143",
        "Clan del Minhiriath": "#9a55d5",
        "Clan dei Druwaith Iaur": "#f3a6b2"
      };

      function pop_Confinipolitici_1(feature, layer) {
        const nome = (feature.properties?.Nome || feature.properties?.name || feature.properties?.label || 'Territorio');
        layer.bindPopup('<strong>' + (nome || '—') + '</strong>');
        layer.bindTooltip(nome, { permanent: false, direction: 'center', className: 'confini-label' });
      }

      // Generatore fallback colore stabile per stringa (HSL -> hex)
      function _hashColor(str) {
        str = String(str || '');
        let h = 0;
        for (let i = 0; i < str.length; i++) h = (h * 31 + str.charCodeAt(i)) >>> 0;
        const hue = h % 360;
        const s = 65, l = 55;
        function hslToHex(h, s, l){
          s/=100; l/=100;
          const k = n => (n + h/30) % 12;
          const a = s * Math.min(l,1-l);
          const f = n => l - a * Math.max(-1, Math.min(k(n)-3, Math.min(9-k(n),1)));
          const toHex = x => Math.round(255*x).toString(16).padStart(2,'0');
          return `#${toHex(f(0))}${toHex(f(8))}${toHex(f(4))}`;
        }
        return hslToHex(hue, s, l);
      }

      map.createPane('pane_Confinipolitici_1');
      map.getPane('pane_Confinipolitici_1').style.zIndex = 400;
      map.getPane('pane_Confinipolitici_1').style['mix-blend-mode'] = 'normal';

      // Prova a prendere la funzione di stile esportata (se esiste)
      var _exportStyleFn = null;
      for (var k in window) {
        if (/^style_Confinipolitici.*$/i.test(k) && typeof window[k] === 'function') {
          _exportStyleFn = window[k]; break;
        }
      }

      var layer_Confinipolitici_1 = new L.geoJson(json_Confinipolitici_1, {
        pane: 'pane_Confinipolitici_1',
        style: function(feature){
          // base: stile di export (se presente)
          let s = _exportStyleFn ? _exportStyleFn(feature) : {};
          if (s == null || typeof s !== 'object') s = {};
          const isPoly = /Polygon/i.test(feature?.geometry?.type || '');

          if (isPoly) {
            const props = feature.properties || {};
            // priorità: mappa hardcoded -> campo 'colore' nel GeoJSON -> fallback hash
            const nome = props.Nome || props.name || '';
            const fromDict = colorByNome[nome];
            const fromField = props.colore;
            const auto = _hashColor(nome);

            if (s.fill === undefined) s.fill = true;
            s.fillColor = fromDict || fromField || s.fillColor || auto;
            if (s.fillOpacity === undefined) s.fillOpacity = 0.65;
            if (s.color === undefined) s.color = '#333';
            if (s.weight === undefined) s.weight = 1;
            if (s.opacity === undefined) s.opacity = 1;
          }
          return s;
        },
        onEachFeature: pop_Confinipolitici_1,
        attribution: '',
        interactive: true
      });
      bounds_group.addLayer(layer_Confinipolitici_1).addTo(map);

      // ---------- Controllo layer ----------
      var overlaysTree = [
        { label: 'Confinipolitici', layer: layer_Confinipolitici_1 },
        { label: 'Insediamenti',    layer: layer_Insediamenti_2 }
      ];
      var lay = L.control.layers.tree(null, overlaysTree, { collapsed: true }).addTo(map);

      // ---------- Fit bounds globale ----------
      try {
        var b = bounds_group.getBounds();
        if (b && b.isValid()) map.fitBounds(b, { padding: [20,20] });
      } catch(e) {}

      // Compatibilità (non usiamo ImageOverlay qui)
      L.ImageOverlay.include({ getBounds: function () { return this._bounds; } });
    </script>
  </body>
</html>
